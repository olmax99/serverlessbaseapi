# Serverless Base Api

This project is providing the base for quickly exposing spread sheet data to a 
serverless RESTApi endpoint in AWS.

Furthermore this project is demonstrating how to integrate the AWS SAM local tool 
with PyCharm while using Pyenv and Pipenv for handling the virtual environment for
Python 3.7.1. It is further used in combination with Docker to run local tests on
AWS Lambda functions.

Next the application will be deployed using AWS Cloudformation in PyCharm.

## Getting Started

The Preparation of the project takes three main steps:

1. Preparing the project environment
2. Syncing PyCharm with Pipenv and AWS tools
3. Running a local serverless test in Docker

These steps are the same for both projects.

NOTE:

This repository is containing two projects, which are put together for ease 
of cloning. After copying I recommend to create one seperate git repositories for
the 'Data Load' and the 'Api' project respectively.

### Prerequisites
 
+ Pyenv
+ Pipenv
+ Python Version 3.7.1
+ PyCharm Professional
+ AWS cli
+ AWS sam cli
+ Docker 

#### Installing
Pyenv and Pipenv is the new way to go for Python version control and virtual environments.
[Visit SecretOfPythonPath project for how to get started](https://github.com/olmax99/secretofpythonpath) 

Docker should be installed on the system, else please read the [official Docker docs](https://docs.docker.com/).

### Prepare the Project's Environment
##### 1. Setting up the virtual environment and AWS tools
It is assumed that you are getting started with the project 'Data Load'. Further, 'DataLoad' should be the project
name when opened in pyCharm. Once cloned from Github, ensure that you have seperated the projects.

In project folder, verify that the correct Python version is set:

```python
$ pyenv local 3.7.1
$ python --version

$ aws --version         # if not installed ensure that the aws cli tool is installed in the global pyenv Python version

# [OPTIONAL]
$ which pip                                 # confirm that you are installing into global version
$ pip install --upgrade --user awscli
```

Set the Virtual Environment Location for pipenv inside project:
```
$ set | grep PIPENV                         # verify that project directory virtualenv is not set
$ export PIPENV_VENV_IN_PROJECT="enabled"   # will create the virtualenv inside the project directory
                                                    
$ pipenv install

# [OPTIONAL]
$ unset PIPENV_VENV_IN_PROJECT              # will reverse the location to default again
                                                    
$ pipenv lock -r > requirements.txt         # will create a requirements.txt file
```

```
$ pipenv install --dev aws-sam-cli          # !!! INSTALL SAM-CLI INTO DEV OTHERWISE LOCAL LAMBDA BUILD MAY FAIL !!!
(DataLoad)$ pipenv shell
(DataLoad)$ sam --version
(DataLoad)$ pipenv graph --json             # also verify in pyCharm > Settings > Project interpreter
```

NOTE: Sam should not be available outside the virtual environment.

##### 2. Sync pyCharm with the virtual environment and AWS tools

In pyCharm > Settings > Plugins install 'AWS Toolkit'. This may require a restart.

Ensure that the path to the sam cli executable matches with pyCharm.
```
$ which sam
```
Settings > Tools > AWS > <path/to>/venv/bin/sam
    
Ensure that the project has a flat structure:
- LoadPermits.py + requirements.txt needs to be on top

Ensure AWS:Profile within pyCharm is in the correct region !!! In this project it will be 'eu-central-1'.

NOTE:

PyCharm has problems with recognizing the in project virtualenvironment `.venv` generated by pipenv. For that 
reason do not choose pipenv after for the 'Project Interpreter', but rather 'Virtualenv Environment'. It is 
recommended to install all packages from the terminal using `pipenv install <package>`.

##### 3. Run a local test with the SAM tool

NOTE:

Ensure that the appropriate docker images are pulled before running a test for the first time in pyCharm !

```
$ docker images

# [OPTIONAL]
docker run lambci/lambda:build-python3.7        # Both runs will fail, but their purpose is just to pull the
docker run lambci/lambda:python3.7              # images locally for pyCharm
```

In case the environment is set up correctly and in sync with pyCharm, there should appear an AWS Lambda Logo
next to the `def lambda_handler` function in LoadPermits.py

- 'Right-click' def lambda_handler      <-- verify that lambda symbol appears, verify Run > Edit Configurations

HINT:   For local cloudformation template debugging: `$ sam validate --debug -t template.yaml`


### Deploy all AWS resources with Cloudformation
##### 1. Data Load Project

In project pane, 'Right-click' samproject_365 > Deploy Serverless Application
    
NOTE:

When deploying serverless application it will deploy the files inside the project's directory as indicated in 
`template.yaml`. Read the in-line comments for more details on Cloudformation.


##### 2. Api Project

WIP

...


##### Troubleshoot
Following are some general suggestions in case of troubleshooting:

- Run > Edit Configurations > AWS Lambda > SAM cli >
        + Build function inside a container:            yes             <-- First time do No !!!
        + Skip checking for newer container images:     yes             <-- SAM WILL FAIL IF NOT SET!!!              
- requirements.txt needs to be in top
- (optionally) create requirements.txt from pipenv
- __init__ and app.py (__main__) needs to be in top
- template.yml determines how pyCharm sam plugin is running the container
- awscli needs to be installed in global python version - it will fail if installed inside venv
        + `$ python --version`                  <-- verify that pyenv is picking up the correct version
        + `$ pip install --upgrade --user`      <-- verify that aws is running inside project dir
```

## Running the tests

1. In pyCharm project panel right-click the tests folder. If configured correctly, choose: Run 'pytest in tests'.
2. In terminal run: 
```
$ PYTHONPATH=$(pwd) python -m pipenv run pytest -v
```


## Author

**OlafMarangone** - *Initial work* - [Serverless Base Api](https://gitlab.com/olmax99/serverlessbaseapi.git)  
contact: olmax99@gmail.com

## License
 
Copyright (C) 2019 Olaf Marangone

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated 
documentation files (the "Software"), to deal in the Software without restriction, including without limitation
the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all copies or substantial portions of the
Software.  
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS 
OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
